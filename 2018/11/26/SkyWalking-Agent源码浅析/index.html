<!DOCTYPE html>
<html >
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Lollipop" />



<meta name="description" content="SkyWalking Agent 入口SkyWalking Agent 采用 JavaAgent 机制，其相关原理可自行 google。SkyWalking Agent 入口在 org.apache.skywalking.apm.agent.SkyWalkingAgent 的 premain() 方法。主要看以下三行代码:">
<meta name="keywords" content="SkyWalking">
<meta property="og:type" content="article">
<meta property="og:title" content="SkyWalking Agent源码浅析">
<meta property="og:url" content="http://yoursite.com/2018/11/26/SkyWalking-Agent源码浅析/index.html">
<meta property="og:site_name" content="小白爬坑之旅">
<meta property="og:description" content="SkyWalking Agent 入口SkyWalking Agent 采用 JavaAgent 机制，其相关原理可自行 google。SkyWalking Agent 入口在 org.apache.skywalking.apm.agent.SkyWalkingAgent 的 premain() 方法。主要看以下三行代码:">
<meta property="og:updated_time" content="2018-11-27T08:36:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SkyWalking Agent源码浅析">
<meta name="twitter:description" content="SkyWalking Agent 入口SkyWalking Agent 采用 JavaAgent 机制，其相关原理可自行 google。SkyWalking Agent 入口在 org.apache.skywalking.apm.agent.SkyWalkingAgent 的 premain() 方法。主要看以下三行代码:">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="小白爬坑之旅" type="application/atom+xml">



    <link rel="shortcut icon" href="/apple-touch-icon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>SkyWalking Agent源码浅析 | 小白爬坑之旅</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/AcFun.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Lollipop</a></h1>
        </hgroup>

        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:a1334416010@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Jimmy2Angel" title="GitHub"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=44324803" title="网易云音乐"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/">String</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thread/">Thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java8/">java8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/queue/">queue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/set/">set</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代理/">代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具使用/">工具使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发包/">并发包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集合类/">集合类</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">小白爬坑中。。。</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Lollipop</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/AcFun.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Lollipop</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:a1334416010@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Jimmy2Angel" title="GitHub"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=44324803" title="网易云音乐"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-SkyWalking-Agent源码浅析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/11/26/SkyWalking-Agent源码浅析/" class="article-date">
      <time datetime="2018-11-26T13:24:06.000Z" itemprop="datePublished">2018-11-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SkyWalking Agent源码浅析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/SkyWalking/">SkyWalking</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SkyWalking/">SkyWalking</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="SkyWalking-Agent-入口"><a href="#SkyWalking-Agent-入口" class="headerlink" title="SkyWalking Agent 入口"></a>SkyWalking Agent 入口</h1><p>SkyWalking Agent 采用 JavaAgent 机制，其相关原理可自行 google。<br>SkyWalking Agent 入口在 org.apache.skywalking.apm.agent.SkyWalkingAgent 的 premain() 方法。主要看以下三行代码:<a id="more"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 初始化配置</span></div><div class="line">SnifferConfigInitializer.initialize(agentArgs);</div><div class="line"> </div><div class="line"><span class="comment">// 初始化插件</span></div><div class="line">pluginFinder = <span class="keyword">new</span> PluginFinder(<span class="keyword">new</span> PluginBootstrap().loadPlugins());</div><div class="line"> </div><div class="line"><span class="comment">// 初始化服务管理</span></div><div class="line">ServiceManager.INSTANCE.boot();</div></pre></td></tr></table></figure>
<h2 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(String agentOptions)</span> <span class="keyword">throws</span> ConfigNotFoundException, AgentPackageNotFoundException </span>&#123;</div><div class="line">    InputStreamReader configFileStream;</div><div class="line"> </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 读取配置文件，默认配置文件 /config/agent.config</span></div><div class="line">        configFileStream = loadConfig();</div><div class="line">        Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">        <span class="comment">// 加载配置文件</span></div><div class="line">        properties.load(configFileStream);</div><div class="line">        <span class="comment">// 用配置文件内容初始化 Config 类</span></div><div class="line">        ConfigInitializer.initialize(properties, Config.class);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(e, <span class="string">"Failed to read the config file, skywalking is going to run in default config."</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 用系统环境变量去覆盖配置</span></div><div class="line">        overrideConfigBySystemEnv();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(e, <span class="string">"Failed to read the system env."</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (!StringUtil.isEmpty(agentOptions)) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            agentOptions = agentOptions.trim();</div><div class="line">            logger.info(<span class="string">"Agent options is &#123;&#125;."</span>, agentOptions);</div><div class="line"></div><div class="line">            <span class="comment">// 用 agentOptions 去覆盖配置</span></div><div class="line">            overrideConfigByAgentOptions(agentOptions);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.error(e, <span class="string">"Failed to parse the agent options, val is &#123;&#125;."</span>, agentOptions);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (StringUtil.isEmpty(Config.Agent.APPLICATION_CODE)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionInInitializerError(<span class="string">"`agent.application_code` is missing."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (StringUtil.isEmpty(Config.Collector.BACKEND_SERVICE)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionInInitializerError(<span class="string">"`collector.direct_servers` and `collector.servers` cannot be empty at the same time."</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    IS_INIT_COMPLETED = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法主要是读取配置文件（默认为 /config/agent.config）内容，初始化 Config 类，若含有相关系统关键变量或 agent 参数可覆盖配置文件的内容。</p>
<h2 id="初始化插件"><a href="#初始化插件" class="headerlink" title="初始化插件"></a>初始化插件</h2><p>SkyWalking Agent 提供了多种插件，实现不同框架的透明接入 SkyWalking。</p>
<h3 id="PluginBootstrap"><a href="#PluginBootstrap" class="headerlink" title="PluginBootstrap"></a>PluginBootstrap</h3><p>PluginBootstrap 为插件引导程序类，创建需要加载的插件对象数组。其 loadPlugins() 方法代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> List&lt;AbstractClassEnhancePluginDefine&gt; <span class="title">loadPlugins</span><span class="params">()</span> <span class="keyword">throws</span> AgentPackageNotFoundException </span>&#123;</div><div class="line">    <span class="comment">// 初始化 AgentClassLoader，它负责负责寻找插件和拦截器</span></div><div class="line">    AgentClassLoader.initDefaultLoader();</div><div class="line"> </div><div class="line">    <span class="comment">// 获得插件定义路径集合</span></div><div class="line">    PluginResourcesResolver resolver = <span class="keyword">new</span> PluginResourcesResolver();</div><div class="line">    List&lt;URL&gt; resources = resolver.getResources();</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (resources == <span class="keyword">null</span> || resources.size() == <span class="number">0</span>) &#123;</div><div class="line">        logger.info(<span class="string">"no plugin files (skywalking-plugin.def) found, continue to start application."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;AbstractClassEnhancePluginDefine&gt;();</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">// 创建插件定义</span></div><div class="line">    <span class="keyword">for</span> (URL pluginUrl : resources) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            PluginCfg.INSTANCE.load(pluginUrl.openStream());</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            logger.error(t, <span class="string">"plugin file [&#123;&#125;] init failure."</span>, pluginUrl);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">// 获得插件定义集合</span></div><div class="line">    List&lt;PluginDefine&gt; pluginClassList = PluginCfg.INSTANCE.getPluginClassList();</div><div class="line">    </div><div class="line">    <span class="comment">// 创建类增强插件定义集合</span></div><div class="line">    List&lt;AbstractClassEnhancePluginDefine&gt; plugins = <span class="keyword">new</span> ArrayList&lt;AbstractClassEnhancePluginDefine&gt;();</div><div class="line">    <span class="keyword">for</span> (PluginDefine pluginDefine : pluginClassList) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            logger.debug(<span class="string">"loading plugin class &#123;&#125;."</span>, pluginDefine.getDefineClass());</div><div class="line">            AbstractClassEnhancePluginDefine plugin =</div><div class="line">                (AbstractClassEnhancePluginDefine)Class.forName(pluginDefine.getDefineClass(),</div><div class="line">                    <span class="keyword">true</span>,</div><div class="line">                    AgentClassLoader.getDefault())</div><div class="line">                    .newInstance();</div><div class="line">            plugins.add(plugin);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            logger.error(t, <span class="string">"load plugin [&#123;&#125;] failure."</span>, pluginDefine.getDefineClass());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> plugins;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="PluginFinder"><a href="#PluginFinder" class="headerlink" title="PluginFinder"></a>PluginFinder</h3><p>PluginFinder 作为一个插件查找器，帮助从一个类增强插件定义集合中查找一个插件。其相关代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, LinkedList&lt;AbstractClassEnhancePluginDefine&gt;&gt; nameMatchDefine = <span class="keyword">new</span> HashMap&lt;String, LinkedList&lt;AbstractClassEnhancePluginDefine&gt;&gt;();</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;AbstractClassEnhancePluginDefine&gt; signatureMatchDefine = <span class="keyword">new</span> LinkedList&lt;AbstractClassEnhancePluginDefine&gt;();</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">PluginFinder</span><span class="params">(List&lt;AbstractClassEnhancePluginDefine&gt; plugins)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (AbstractClassEnhancePluginDefine plugin : plugins) &#123;</div><div class="line">        ClassMatch match = plugin.enhanceClass();</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (match == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="comment">// 处理 NameMatch 为匹配的 AbstractClassEnhancePluginDefine 对象，添加到 `nameMatchDefine` 属性。</span></div><div class="line">        <span class="keyword">if</span> (match <span class="keyword">instanceof</span> NameMatch) &#123;</div><div class="line">            NameMatch nameMatch = (NameMatch)match;</div><div class="line">            LinkedList&lt;AbstractClassEnhancePluginDefine&gt; pluginDefines = nameMatchDefine.get(nameMatch.getClassName());</div><div class="line">            <span class="keyword">if</span> (pluginDefines == <span class="keyword">null</span>) &#123;</div><div class="line">                pluginDefines = <span class="keyword">new</span> LinkedList&lt;AbstractClassEnhancePluginDefine&gt;();</div><div class="line">                nameMatchDefine.put(nameMatch.getClassName(), pluginDefines);</div><div class="line">            &#125;</div><div class="line">            pluginDefines.add(plugin);</div><div class="line">        &#125; </div><div class="line">        <span class="comment">// 处理非 NameMatch 为匹配的 AbstractClassEnhancePluginDefine 对象，添加到 `signatureMatchDefine` 属性。</span></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            signatureMatchDefine.add(plugin);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="初始化服务管理"><a href="#初始化服务管理" class="headerlink" title="初始化服务管理"></a>初始化服务管理</h2><p>ServiceManager.INSTANCE.boot() 方法初始化所有的 BootService 实现。并进行其准备阶段逻辑、启动阶段逻辑、完成阶段逻辑。详见下文。</p>
<h1 id="ServiceManager"><a href="#ServiceManager" class="headerlink" title="ServiceManager"></a>ServiceManager</h1><p>ServiceManager 作为 BootService 管理器，负责初始化所有的 BootService 实现。并进行其准备阶段逻辑、启动阶段逻辑、完成阶段逻辑。<br>其相关代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Map&lt;Class, BootService&gt; bootedServices = Collections.emptyMap();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boot</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 加载所有 bootService</span></div><div class="line">    bootedServices = loadAllServices();</div><div class="line">    <span class="comment">// 准备逻辑</span></div><div class="line">    prepare();</div><div class="line">    <span class="comment">// 启动逻辑</span></div><div class="line">    startup();</div><div class="line">    <span class="comment">// 完成逻辑</span></div><div class="line">    onComplete();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 加载所有的 BootService</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.skywalking.apm.agent.core.remote.TraceSegmentServiceClient&#125;</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.skywalking.apm.agent.core.context.ContextManager&#125;</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.skywalking.apm.agent.core.sampling.SamplingService&#125;</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.skywalking.apm.agent.core.remote.GRPCChannelManager&#125;</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.skywalking.apm.agent.core.jvm.JVMService&#125;</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.skywalking.apm.agent.core.remote.AppAndServiceRegisterClient&#125;</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.skywalking.apm.agent.core.context.ContextManagerExtendService&#125;</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> bootedServices</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;Class, BootService&gt; <span class="title">loadAllServices</span><span class="params">()</span> </span>&#123;</div><div class="line">    Map&lt;Class, BootService&gt; bootedServices = <span class="keyword">new</span> LinkedHashMap&lt;Class, BootService&gt;();</div><div class="line">    List&lt;BootService&gt; allServices = <span class="keyword">new</span> LinkedList&lt;BootService&gt;();</div><div class="line">    <span class="comment">// 加载所有的 bootService</span></div><div class="line">    load(allServices);</div><div class="line">    Iterator&lt;BootService&gt; serviceIterator = allServices.iterator();</div><div class="line">    <span class="keyword">while</span> (serviceIterator.hasNext()) &#123;</div><div class="line">        BootService bootService = serviceIterator.next();</div><div class="line"></div><div class="line">        Class&lt;? extends BootService&gt; bootServiceClass = bootService.getClass();</div><div class="line">        <span class="comment">// 该 bootService 上有 DefaultImplementor 注解则添加</span></div><div class="line">        <span class="keyword">boolean</span> isDefaultImplementor = bootServiceClass.isAnnotationPresent(DefaultImplementor.class);</div><div class="line">        <span class="keyword">if</span> (isDefaultImplementor) &#123;</div><div class="line">            <span class="keyword">if</span> (!bootedServices.containsKey(bootServiceClass)) &#123;</div><div class="line">                bootedServices.put(bootServiceClass, bootService);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//ignore the default service</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            OverrideImplementor overrideImplementor = bootServiceClass.getAnnotation(OverrideImplementor.class);</div><div class="line">            <span class="comment">// 该 bootService 上没有 DefaultImplementor 注解但是也没有 OverrideImplementor 注解，也添加</span></div><div class="line">            <span class="keyword">if</span> (overrideImplementor == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (!bootedServices.containsKey(bootServiceClass)) &#123;</div><div class="line">                    bootedServices.put(bootServiceClass, bootService);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServiceConflictException(<span class="string">"Duplicate service define for :"</span> + bootServiceClass);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 该 bootService 上没有 DefaultImplementor 注解，有 OverrideImplementor 注解</span></div><div class="line">                <span class="comment">// 如果 OverrideImplementor 注解的 value 表明的 bootService 上有 DefaultImplementor 注解，也添加</span></div><div class="line">                Class&lt;? extends BootService&gt; targetService = overrideImplementor.value();</div><div class="line">                <span class="keyword">if</span> (bootedServices.containsKey(targetService)) &#123;</div><div class="line">                    <span class="keyword">boolean</span> presentDefault = bootedServices.get(targetService).getClass().isAnnotationPresent(DefaultImplementor.class);</div><div class="line">                    <span class="keyword">if</span> (presentDefault) &#123;</div><div class="line">                        bootedServices.put(targetService, bootService);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceConflictException(<span class="string">"Service "</span> + bootServiceClass + <span class="string">" overrides conflict, "</span> +</div><div class="line">                            <span class="string">"exist more than one service want to override :"</span> + targetService);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    bootedServices.put(targetService, bootService);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> bootedServices;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 遍历 bootedServices，执行各个 bootService 的准备阶段逻辑，startup、onComplete、shutdown 均与此类似。</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (BootService service : bootedServices.values()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            service.prepare();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            logger.error(e, <span class="string">"ServiceManager try to pre-start [&#123;&#125;] fail."</span>, service.getClass().getName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T extends BootService&gt; <span class="function">T <span class="title">findService</span><span class="params">(Class&lt;T&gt; serviceClass)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (T)bootedServices.get(serviceClass);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 根据 ServiceLoader 去加载 bootService</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(List&lt;BootService&gt; allServices)</span> </span>&#123;</div><div class="line">    Iterator&lt;BootService&gt; iterator = ServiceLoader.load(BootService.class, AgentClassLoader.getDefault()).iterator();</div><div class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">        allServices.add(iterator.next());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="BootService"><a href="#BootService" class="headerlink" title="BootService"></a>BootService</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BootService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">boot</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>BootService 是一个接口，下面针对四个抽象方法逐一分析其实现。</p>
<h2 id="TraceSegmentServiceClient"><a href="#TraceSegmentServiceClient" class="headerlink" title="TraceSegmentServiceClient"></a>TraceSegmentServiceClient</h2><p>TraceSegmentServiceClient 负责将 TraceSegment 异步发送到 Collector，其相关代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">long</span> lastLogTime;</div><div class="line"><span class="keyword">private</span> <span class="keyword">long</span> segmentUplinkedCounter;</div><div class="line"><span class="keyword">private</span> <span class="keyword">long</span> segmentAbandonedCounter;</div><div class="line"><span class="comment">// 内存队列，生产者消费者模型实现</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> DataCarrier&lt;TraceSegment&gt; carrier;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> TraceSegmentServiceGrpc.TraceSegmentServiceStub serviceStub;</div><div class="line"><span class="comment">// GRPCChannel 连接状态</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> GRPCChannelStatus status = GRPCChannelStatus.DISCONNECT;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 将自己添加到 GRPCChannelManager 的监听器中</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    ServiceManager.INSTANCE.findService(GRPCChannelManager.class).addChannelListener(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boot</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    lastLogTime = System.currentTimeMillis();</div><div class="line">    segmentUplinkedCounter = <span class="number">0</span>;</div><div class="line">    segmentAbandonedCounter = <span class="number">0</span>;</div><div class="line">    <span class="comment">// 创建 DataCarrier，方法内部会创建 Channels、Buffer等</span></div><div class="line">    carrier = <span class="keyword">new</span> DataCarrier&lt;TraceSegment&gt;(CHANNEL_SIZE, BUFFER_SIZE);</div><div class="line">    <span class="comment">// 设置策略</span></div><div class="line">    carrier.setBufferStrategy(BufferStrategy.IF_POSSIBLE);</div><div class="line">    <span class="comment">// 给 DataCarrier 设置消费者，方法内部会创建ConsumerPool、ConsumerThread等</span></div><div class="line">    carrier.consume(<span class="keyword">this</span>, <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="comment">// 添加到 TracingContext 的监听器集合中</span></div><div class="line">    TracingContext.ListenerManager.add(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="comment">// 关闭 consumerPool</span></div><div class="line">    carrier.shutdownConsumers();</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">(List&lt;TraceSegment&gt; data)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (CONNECTED.equals(status)) &#123;</div><div class="line">        <span class="comment">// 创建 GRPCStreamServiceStatus 对象</span></div><div class="line">        <span class="keyword">final</span> GRPCStreamServiceStatus status = <span class="keyword">new</span> GRPCStreamServiceStatus(<span class="keyword">false</span>);</div><div class="line">        <span class="comment">// 创建 StreamObserver 对象</span></div><div class="line">        StreamObserver&lt;UpstreamSegment&gt; upstreamSegmentStreamObserver = serviceStub.collect(<span class="keyword">new</span> StreamObserver&lt;Downstream&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Downstream downstream)</span> </span>&#123;</div><div class="line"> </div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">                status.finished();</div><div class="line">                <span class="keyword">if</span> (logger.isErrorEnable()) &#123;</div><div class="line">                    logger.error(throwable, <span class="string">"Send UpstreamSegment to collector fail with a grpc internal exception."</span>);</div><div class="line">                &#125;</div><div class="line">                ServiceManager.INSTANCE.findService(GRPCChannelManager.class).reportError(throwable);</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                status.finished();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        <span class="comment">// 逐条非阻塞发送 TraceSegment 请求</span></div><div class="line">        <span class="keyword">for</span> (TraceSegment segment : data) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 将 TraceSegment 转换成 UpstreamSegment 对象，用于 gRPC 传输</span></div><div class="line">                UpstreamSegment upstreamSegment = segment.transform();</div><div class="line">                upstreamSegmentStreamObserver.onNext(upstreamSegment);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                logger.error(t, <span class="string">"Transform and send UpstreamSegment to collector fail."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 标记全部请求发送完成</span></div><div class="line">        upstreamSegmentStreamObserver.onCompleted();</div><div class="line"> </div><div class="line">        <span class="comment">// 等待 Collector 处理完成</span></div><div class="line">        status.wait4Finish();</div><div class="line">        <span class="comment">// 记录数量到 segmentAbandonedCounter</span></div><div class="line">        segmentUplinkedCounter += data.size();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 记录数量到 segmentAbandonedCounter</span></div><div class="line">        segmentAbandonedCounter += data.size();</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    printUplinkStatus();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="DataCarrier"><a href="#DataCarrier" class="headerlink" title="DataCarrier"></a>DataCarrier</h3><p>DataCarrier 作为一个内存队列，采用生产者／消费者模型实现。相关代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> bufferSize;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> channelSize;</div><div class="line"><span class="comment">// 持有一个 Buffer&lt;T&gt;[]</span></div><div class="line"><span class="keyword">private</span> Channels&lt;T&gt; channels;</div><div class="line"><span class="comment">// 持有一个 ConsumerThread[]</span></div><div class="line"><span class="keyword">private</span> ConsumerPool&lt;T&gt; consumerPool;</div><div class="line"><span class="keyword">private</span> String name;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">DataCarrier</span><span class="params">(<span class="keyword">int</span> channelSize, <span class="keyword">int</span> bufferSize)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(<span class="string">"default"</span>, channelSize, bufferSize);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">DataCarrier</span><span class="params">(String name, <span class="keyword">int</span> channelSize, <span class="keyword">int</span> bufferSize)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = name;</div><div class="line">    <span class="keyword">this</span>.bufferSize = bufferSize;</div><div class="line">    <span class="keyword">this</span>.channelSize = channelSize;</div><div class="line">    <span class="comment">// 创建一个 Channels</span></div><div class="line">    channels = <span class="keyword">new</span> Channels&lt;T&gt;(channelSize, bufferSize, <span class="keyword">new</span> SimpleRollingPartitioner&lt;T&gt;(), BufferStrategy.BLOCKING);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">produce</span><span class="params">(T data)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (consumerPool != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!consumerPool.isRunning()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 保存数据到 channels 的 buffer 中</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channels.save(data);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * set consumers to this Carrier. consumer begin to run when &#123;<span class="doctag">@link</span> DataCarrier#produce&#125; begin to work.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> consumer single instance of consumer, all consumer threads will all use this instance.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> num number of consumer threads</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> DataCarrier <span class="title">consume</span><span class="params">(IConsumer&lt;T&gt; consumer, <span class="keyword">int</span> num, <span class="keyword">long</span> consumeCycle)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (consumerPool != <span class="keyword">null</span>) &#123;</div><div class="line">        consumerPool.close();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 创建一个 ConsumerPool，内部创建一个 ConsumerThread[num]，多个 ConsumerThread 持有同一个 consumer</span></div><div class="line">    <span class="comment">// 这里的 consumer 也就是 TraceSegmentServiceClient</span></div><div class="line">    consumerPool = <span class="keyword">new</span> ConsumerPool&lt;T&gt;(<span class="keyword">this</span>.name, <span class="keyword">this</span>.channels, consumer, num, consumeCycle);</div><div class="line">    <span class="comment">// 开启 consumerPool</span></div><div class="line">    consumerPool.begin();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h3><p>在 DataCarrier 的构造方法中会创建一个 Channels 对象，它包含所有属于它的 Buffer 的数据。当 Buffer 已满的时候，支持不同策略，默认为 BLOCKING。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">channels = <span class="keyword">new</span> Channels&lt;T&gt;(channelSize, bufferSize, <span class="keyword">new</span> SimpleRollingPartitioner&lt;T&gt;(), BufferStrategy.BLOCKING);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Channels</span><span class="params">(<span class="keyword">int</span> channelSize, <span class="keyword">int</span> bufferSize, IDataPartitioner&lt;T&gt; partitioner, BufferStrategy strategy)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.dataPartitioner = partitioner;</div><div class="line">    <span class="keyword">this</span>.strategy = strategy;</div><div class="line">    <span class="comment">// 根据 channelSize 创建一个 Buffer 数组</span></div><div class="line">    bufferChannels = <span class="keyword">new</span> Buffer[channelSize];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; channelSize; i++) &#123;</div><div class="line">        bufferChannels[i] = <span class="keyword">new</span> Buffer&lt;T&gt;(bufferSize, strategy);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">// 保存数据</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">(T data)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> index = dataPartitioner.partition(bufferChannels.length, data);</div><div class="line">    <span class="keyword">int</span> retryCountDown = <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (BufferStrategy.IF_POSSIBLE.equals(strategy)) &#123;</div><div class="line">        <span class="keyword">int</span> maxRetryCount = dataPartitioner.maxRetryCount();</div><div class="line">        <span class="keyword">if</span> (maxRetryCount &gt; <span class="number">1</span>) &#123;</div><div class="line">            retryCountDown = maxRetryCount;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (; retryCountDown &gt; <span class="number">0</span>; retryCountDown--) &#123;</div><div class="line">        <span class="comment">// 调用 Buffer 的 save() 方法</span></div><div class="line">        <span class="keyword">if</span> (bufferChannels[index].save(data)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h3><p>Buffer 在保存数据时，把 buffer 作为一个 “环”，使用 index 记录最后存储的位置，不断向下，循环存储到 buffer 中。<br>通过这样的方式，带来良好的存储性能，避免扩容问题。但是 ，存储会存在冲突的问题：buffer 写入位置，暂未被消费，已经存在值。此时，根据不同的 BufferStrategy 进行处理。<br>相关代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object[] buffer;</div><div class="line"><span class="keyword">private</span> BufferStrategy strategy;</div><div class="line"><span class="keyword">private</span> AtomicRangeInteger index;</div><div class="line"><span class="keyword">private</span> List&lt;QueueBlockingCallback&lt;T&gt;&gt; callbacks;</div><div class="line"> </div><div class="line">Buffer(<span class="keyword">int</span> bufferSize, BufferStrategy strategy) &#123;</div><div class="line">    buffer = <span class="keyword">new</span> Object[bufferSize];</div><div class="line">    <span class="keyword">this</span>.strategy = strategy;</div><div class="line">    index = <span class="keyword">new</span> AtomicRangeInteger(<span class="number">0</span>, bufferSize);</div><div class="line">    callbacks = <span class="keyword">new</span> LinkedList&lt;QueueBlockingCallback&lt;T&gt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Buffer 在保存数据时，把 buffer 作为一个 "环"，使用 index 记录最后存储的位置，不断向下，循环存储到 buffer 中。</span></div><div class="line"><span class="comment"> * 通过这样的方式，带来良好的存储性能，避免扩容问题。</span></div><div class="line"><span class="comment"> * 但是 ，存储会存在冲突的问题：buffer 写入位置，暂未被消费，已经存在值。此时，根据不同的 BufferStrategy 进行处理</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">save</span><span class="params">(T data)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = index.getAndIncrement();</div><div class="line">    <span class="keyword">if</span> (buffer[i] != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">switch</span> (strategy) &#123;</div><div class="line">            <span class="keyword">case</span> BLOCKING:</div><div class="line">                <span class="keyword">boolean</span> isFirstTimeBlocking = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">while</span> (buffer[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (isFirstTimeBlocking) &#123;</div><div class="line">                        isFirstTimeBlocking = <span class="keyword">false</span>;</div><div class="line">                        <span class="keyword">for</span> (QueueBlockingCallback&lt;T&gt; callback : callbacks) &#123;</div><div class="line">                            callback.notify(data);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep(<span class="number">1L</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> IF_POSSIBLE:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">case</span> OVERRIDE:</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    buffer[i] = data;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ConsumerPool"><a href="#ConsumerPool" class="headerlink" title="ConsumerPool"></a>ConsumerPool</h3><p>ConsumerPool 持有一个 ConsumerThread 数组和 channels 引用。<br>ConsumerPool 含有两个同名构造函数，一个是里面的每个 ConsumerThread 持有同一个 consumer 实例，一个是里面的每个 ConsumerThread 持有各自的 consumer 实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> running;</div><div class="line"><span class="keyword">private</span> ConsumerThread[] consumerThreads;</div><div class="line"><span class="keyword">private</span> Channels&lt;T&gt; channels;</div><div class="line"><span class="keyword">private</span> ReentrantLock lock;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 每个 ConsumerThread 持有各自的 consumer 实例</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConsumerPool</span><span class="params">(String name, Channels&lt;T&gt; channels, Class&lt;? extends IConsumer&lt;T&gt;&gt; consumerClass, <span class="keyword">int</span> num,</span></span></div><div class="line"><span class="function"><span class="params">    <span class="keyword">long</span> consumeCycle)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(channels, num);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</div><div class="line">        consumerThreads[i] = <span class="keyword">new</span> ConsumerThread(<span class="string">"DataCarrier."</span> + name + <span class="string">".Consumser."</span> + i + <span class="string">".Thread"</span>, getNewConsumerInstance(consumerClass), consumeCycle);</div><div class="line">        consumerThreads[i].setDaemon(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 每个 ConsumerThread 持有相同的 consumer 实例</span></div><div class="line"><span class="comment"> */</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConsumerPool</span><span class="params">(String name, Channels&lt;T&gt; channels, IConsumer&lt;T&gt; prototype, <span class="keyword">int</span> num, <span class="keyword">long</span> consumeCycle)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(channels, num);</div><div class="line">    prototype.init();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</div><div class="line">        consumerThreads[i] = <span class="keyword">new</span> ConsumerThread(<span class="string">"DataCarrier."</span> + name + <span class="string">".Consumser."</span> + i + <span class="string">".Thread"</span>, prototype, consumeCycle);</div><div class="line">        consumerThreads[i].setDaemon(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">ConsumerPool</span><span class="params">(Channels&lt;T&gt; channels, <span class="keyword">int</span> num)</span> </span>&#123;</div><div class="line">    running = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">this</span>.channels = channels;</div><div class="line">    consumerThreads = <span class="keyword">new</span> ConsumerThread[num];</div><div class="line">    lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (running) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="comment">// 将 Buffer 分配给 线程</span></div><div class="line">        <span class="keyword">this</span>.allocateBuffer2Thread();</div><div class="line">        <span class="comment">// 启动 ConsumerThread 开始执行任务</span></div><div class="line">        <span class="keyword">for</span> (ConsumerThread consumerThread : consumerThreads) &#123;</div><div class="line">            consumerThread.start();</div><div class="line">        &#125;</div><div class="line">        running = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ConsumerThread"><a href="#ConsumerThread" class="headerlink" title="ConsumerThread"></a>ConsumerThread</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running;</div><div class="line"><span class="keyword">private</span> IConsumer&lt;T&gt; consumer;</div><div class="line"><span class="comment">// 分配给该线程的 Buffer，持有 start 和 end 位置</span></div><div class="line"><span class="keyword">private</span> List&lt;DataSource&gt; dataSources;</div><div class="line"><span class="keyword">private</span> <span class="keyword">long</span> consumeCycle;</div><div class="line"> </div><div class="line">ConsumerThread(String threadName, IConsumer&lt;T&gt; consumer, <span class="keyword">long</span> consumeCycle) &#123;</div><div class="line">    <span class="keyword">super</span>(threadName);</div><div class="line">    <span class="keyword">this</span>.consumer = consumer;</div><div class="line">    running = <span class="keyword">false</span>;</div><div class="line">    dataSources = <span class="keyword">new</span> LinkedList&lt;DataSource&gt;();</div><div class="line">    <span class="keyword">this</span>.consumeCycle = consumeCycle;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    running = <span class="keyword">true</span>;</div><div class="line"> </div><div class="line">    <span class="keyword">while</span> (running) &#123;</div><div class="line">        <span class="keyword">boolean</span> hasData = consume();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!hasData) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(consumeCycle);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">// consumer thread is going to stop</span></div><div class="line">    <span class="comment">// consume the last time</span></div><div class="line">    consume();</div><div class="line"> </div><div class="line">    consumer.onExit();</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> hasData = <span class="keyword">false</span>;</div><div class="line">    LinkedList&lt;T&gt; consumeList = <span class="keyword">new</span> LinkedList&lt;T&gt;();</div><div class="line">    <span class="keyword">for</span> (DataSource dataSource : dataSources) &#123;</div><div class="line">        LinkedList&lt;T&gt; data = dataSource.obtain();</div><div class="line">        <span class="keyword">if</span> (data.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (T element : data) &#123;</div><div class="line">            consumeList.add(element);</div><div class="line">        &#125;</div><div class="line">        hasData = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (consumeList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// TraceSegmentServiceClient 为 IConsumer 实现之一，回头看看 TraceSegmentServiceClient 的 consume 方法</span></div><div class="line">            consumer.consume(consumeList);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            consumer.onError(consumeList, t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> hasData;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ContextManager"><a href="#ContextManager" class="headerlink" title="ContextManager"></a>ContextManager</h2><p>ContextManager 作为 TraceSegment 的上下文管理器（TraceSegment 详细内容在此不做深究），该类的相关变量如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 持有一个 TraceSegment 的 上下文 Context，由于 TraceSegment 涉及到多线程的问题，所以这里采用 ThreadLocal 持有 context。</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;AbstractTracerContext&gt; CONTEXT = <span class="keyword">new</span> ThreadLocal&lt;AbstractTracerContext&gt;();</div><div class="line"><span class="comment">// 持有一个运行时上下文，同样用 ThreadLocal 持有。</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;RuntimeContext&gt; RUNTIME_CONTEXT = <span class="keyword">new</span> ThreadLocal&lt;RuntimeContext&gt;();</div><div class="line"><span class="comment">// ContextManagerExtendService 作为一个扩展类，帮助 ContextManager 实现创建 context 的功能。同时它也是 BootService 的一个实现类。</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ContextManagerExtendService EXTEND_SERVICE;</div></pre></td></tr></table></figure></p>
<p>它的 prepare()、onComplete()、shutdown() 方法均没有具体实现内容，来看 boot() 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boot</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 从 ServiceManager 中获取 ContextManagerExtendService，并将 this 添加到它的监听器中。</span></div><div class="line">    <span class="comment">// 当 TracingContext 完成时会调用 ContextManager 的 afterFinished() 方法</span></div><div class="line">    ContextManagerExtendService service = ServiceManager.INSTANCE.findService(ContextManagerExtendService.class);</div><div class="line">    service.registerListeners(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="SamplingService"><a href="#SamplingService" class="headerlink" title="SamplingService"></a>SamplingService</h2><p>SamplingService 负责管理如何对 TraceSegment 进行采样。<br>考虑到如果每条 TraceSegment 都进行追踪，会带来一定的 CPU ( 用于序列化与反序列化 ) 和网络的开销。<br>通过配置 <code>Config.Agent.SAMPLE_N_PER_3_SECS</code> 属性，设置每三秒，收集 TraceSegment 的条数。<br>其相关代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 开关</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> on = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> AtomicInteger samplingFactorHolder;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ScheduledFuture&lt;?&gt; scheduledFuture;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boot</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="keyword">if</span> (scheduledFuture != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * If &#123;<span class="doctag">@link</span> #boot()&#125; invokes twice, mostly in test cases,</span></div><div class="line"><span class="comment">         * cancel the old one.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        scheduledFuture.cancel(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// SAMPLE_N_PER_3_SECS 可在 /config/agent.config 文件中配置</span></div><div class="line">    <span class="keyword">if</span> (Config.Agent.SAMPLE_N_PER_3_SECS &gt; <span class="number">0</span>) &#123;</div><div class="line">        on = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">this</span>.resetSamplingFactor();</div><div class="line">        ScheduledExecutorService service = Executors</div><div class="line">            .newSingleThreadScheduledExecutor(<span class="keyword">new</span> DefaultNamedThreadFactory(<span class="string">"SamplingService"</span>));</div><div class="line">        <span class="comment">// 每3s调用一次 resetSamplingFactor() 重置计数器</span></div><div class="line">        scheduledFuture = service.scheduleAtFixedRate(<span class="keyword">new</span> RunnableWithExceptionProtection(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                resetSamplingFactor();</div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="keyword">new</span> RunnableWithExceptionProtection.CallbackWhenException() &#123;</div><div class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                logger.error(<span class="string">"unexpected exception."</span>, t);</div><div class="line">            &#125;</div><div class="line">        &#125;), <span class="number">0</span>, <span class="number">3</span>, TimeUnit.SECONDS);</div><div class="line">        logger.debug(<span class="string">"Agent sampling mechanism started. Sample &#123;&#125; traces in 10 seconds."</span>, Config.Agent.SAMPLE_N_PER_3_SECS);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="comment">// 取消 scheduledFuture </span></div><div class="line">    <span class="keyword">if</span> (scheduledFuture != <span class="keyword">null</span>) &#123;</div><div class="line">        scheduledFuture.cancel(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="GRPCChannelManager"><a href="#GRPCChannelManager" class="headerlink" title="GRPCChannelManager"></a>GRPCChannelManager</h2><p>GRPCChannelManager 作为 GRPCChannel 的管理器，负责创建 GRPCChannel 以及在连接状态发生改变时给各个监听器发送通知。相关代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 创建一个 ScheduledFuture</span></div><div class="line"><span class="comment"> * this 的 run 方法每 30s 执行一次</span></div><div class="line"><span class="comment"> * <span class="doctag">@throws</span> Throwable</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boot</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Config.Collector.BACKEND_SERVICE.trim().length() == <span class="number">0</span>) &#123;</div><div class="line">        logger.error(<span class="string">"Collector server addresses are not set."</span>);</div><div class="line">        logger.error(<span class="string">"Agent will not uplink any data."</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 根据 BACKEND_SERVICE 获取 Collector 的地址</span></div><div class="line">    grpcServers = Arrays.asList(Config.Collector.BACKEND_SERVICE.split(<span class="string">","</span>));</div><div class="line">    connectCheckFuture = Executors</div><div class="line">        .newSingleThreadScheduledExecutor(<span class="keyword">new</span> DefaultNamedThreadFactory(<span class="string">"GRPCChannelManager"</span>))</div><div class="line">        .scheduleAtFixedRate(<span class="keyword">new</span> RunnableWithExceptionProtection(<span class="keyword">this</span>, <span class="keyword">new</span> RunnableWithExceptionProtection.CallbackWhenException() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                logger.error(<span class="string">"unexpected exception."</span>, t);</div><div class="line">            &#125;</div><div class="line">        &#125;), <span class="number">0</span>, Config.Collector.GRPC_CHANNEL_CHECK_INTERVAL, TimeUnit.SECONDS);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 关闭 managedChannel</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    connectCheckFuture.cancel(<span class="keyword">true</span>);</div><div class="line">    <span class="keyword">if</span> (managedChannel != <span class="keyword">null</span>) &#123;</div><div class="line">        managedChannel.shutdownNow();</div><div class="line">    &#125;</div><div class="line">    logger.debug(<span class="string">"Selected collector grpc service shutdown."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    logger.debug(<span class="string">"Selected collector grpc service running, reconnect:&#123;&#125;."</span>, reconnect);</div><div class="line">    <span class="keyword">if</span> (reconnect) &#123;</div><div class="line">        <span class="keyword">if</span> (grpcServers.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            String server = <span class="string">""</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 选取一个服务器</span></div><div class="line">                <span class="keyword">int</span> index = Math.abs(random.nextInt()) % grpcServers.size();</div><div class="line">                server = grpcServers.get(index);</div><div class="line">                String[] ipAndPort = server.split(<span class="string">":"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// 根据 ip 和 port 创建一个 GRPCChannel</span></div><div class="line">                managedChannel = GRPCChannel.newBuilder(ipAndPort[<span class="number">0</span>], Integer.parseInt(ipAndPort[<span class="number">1</span>]))</div><div class="line">                    .addManagedChannelBuilder(<span class="keyword">new</span> StandardChannelBuilder())</div><div class="line">                    .addManagedChannelBuilder(<span class="keyword">new</span> TLSChannelBuilder())</div><div class="line">                    .addChannelDecorator(<span class="keyword">new</span> AuthenticationDecorator())</div><div class="line">                    .build();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!managedChannel.isShutdown() &amp;&amp; !managedChannel.isTerminated()) &#123;</div><div class="line">                    reconnect = <span class="keyword">false</span>;</div><div class="line">                    <span class="comment">// 通知所有监听器listener： GRPCChannel 连接了</span></div><div class="line">                    notify(GRPCChannelStatus.CONNECTED);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// 通知所有监听器listener： GRPCChannel 失去连接了</span></div><div class="line">                    notify(GRPCChannelStatus.DISCONNECT);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                logger.error(t, <span class="string">"Create channel to &#123;&#125; fail."</span>, server);</div><div class="line">                notify(GRPCChannelStatus.DISCONNECT);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        logger.debug(<span class="string">"Selected collector grpc service is not available. Wait &#123;&#125; seconds to retry"</span>, Config.Collector.GRPC_CHANNEL_CHECK_INTERVAL);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * 连接状态改变时给监听器发送连接状态</span></div><div class="line"><span class="comment"> *／</span></div><div class="line"><span class="comment">private void notify(GRPCChannelStatus status) &#123;</span></div><div class="line"><span class="comment">    // 已知的 listener 有 AppAndServiceRegisterClient、TraceSegmentServiceClient、JVMService.Send</span></div><div class="line"><span class="comment">    for (GRPCChannelListener listener : listeners) &#123;</span></div><div class="line"><span class="comment">        try &#123;</span></div><div class="line"><span class="comment">            listener.statusChanged(status);</span></div><div class="line"><span class="comment">        &#125; catch (Throwable t) &#123;</span></div><div class="line"><span class="comment">            logger.error(t, "Fail to notify &#123;&#125; about channel connected.", listener.getClass().getName());</span></div><div class="line"><span class="comment">        &#125;</span></div><div class="line"><span class="comment">    &#125;</span></div><div class="line"><span class="comment">&#125;</span></div></pre></td></tr></table></figure></p>
<h2 id="JVMService"><a href="#JVMService" class="headerlink" title="JVMService"></a>JVMService</h2><p>JVMService 收集 JVM cpu, memory, memorypool 和 gc 信息发送给 Collector。</p>
<h2 id="AppAndServiceRegisterClient"><a href="#AppAndServiceRegisterClient" class="headerlink" title="AppAndServiceRegisterClient"></a>AppAndServiceRegisterClient</h2><p>AppAndServiceRegisterClient 负责服务和服务实例的注册及心跳检测。主要做了以下几件事:</p>
<ul>
<li>准备阶段 prepare() 将自己注册为 GRPCChannelManager 的监听器。</li>
<li>接收 GRPCChannelManager 发送的 GRPCChannel 连接状态。 </li>
<li>创建一个 ScheduledFuture，每 3s 执行一次任务。</li>
<li>执行任务时根据 GRPCChannel 连接状态以及 APPLICATION_ID 进行服务注册/服务实例注册/服务实例心跳检测。<br>其相关代码如下:<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 服务和服务实例注册客户端</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> wusheng</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@DefaultImplementor</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppAndServiceRegisterClient</span> <span class="keyword">implements</span> <span class="title">BootService</span>, <span class="title">Runnable</span>, <span class="title">GRPCChannelListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ILog logger = LogManager.getLogger(AppAndServiceRegisterClient.class);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROCESS_UUID = UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>);</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> GRPCChannelStatus status = GRPCChannelStatus.DISCONNECT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ApplicationRegisterServiceGrpc.ApplicationRegisterServiceBlockingStub applicationRegisterServiceBlockingStub;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceDiscoveryServiceGrpc.InstanceDiscoveryServiceBlockingStub instanceDiscoveryServiceBlockingStub;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServiceNameDiscoveryServiceGrpc.ServiceNameDiscoveryServiceBlockingStub serviceNameDiscoveryServiceBlockingStub;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> NetworkAddressRegisterServiceGrpc.NetworkAddressRegisterServiceBlockingStub networkAddressRegisterServiceBlockingStub;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ScheduledFuture&lt;?&gt; applicationRegisterFuture;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 从 GRPCChannelManager notify() 获取到连接状态</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusChanged</span><span class="params">(GRPCChannelStatus status)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (GRPCChannelStatus.CONNECTED.equals(status)) &#123;</div><div class="line">            <span class="comment">// 获取带 AuthenticationDecorator 装饰的 channel</span></div><div class="line">            Channel channel = ServiceManager.INSTANCE.findService(GRPCChannelManager.class).getChannel();</div><div class="line">            applicationRegisterServiceBlockingStub = ApplicationRegisterServiceGrpc.newBlockingStub(channel);</div><div class="line">            instanceDiscoveryServiceBlockingStub = InstanceDiscoveryServiceGrpc.newBlockingStub(channel);</div><div class="line">            serviceNameDiscoveryServiceBlockingStub = ServiceNameDiscoveryServiceGrpc.newBlockingStub(channel);</div><div class="line">            networkAddressRegisterServiceBlockingStub = NetworkAddressRegisterServiceGrpc.newBlockingStub(channel);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            applicationRegisterServiceBlockingStub = <span class="keyword">null</span>;</div><div class="line">            instanceDiscoveryServiceBlockingStub = <span class="keyword">null</span>;</div><div class="line">            serviceNameDiscoveryServiceBlockingStub = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 设置状态</span></div><div class="line">        <span class="keyword">this</span>.status = status;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">      将自己添加到 GRPCChannelManager 的监听器中</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        ServiceManager.INSTANCE.findService(GRPCChannelManager.class).addChannelListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 创建一个 ScheduledFuture</span></div><div class="line"><span class="comment">     * this 的 run 方法每 3s 执行一次</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">boot</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        applicationRegisterFuture = Executors</div><div class="line">            .newSingleThreadScheduledExecutor(<span class="keyword">new</span> DefaultNamedThreadFactory(<span class="string">"AppAndServiceRegisterClient"</span>))</div><div class="line">            .scheduleAtFixedRate(<span class="keyword">new</span> RunnableWithExceptionProtection(<span class="keyword">this</span>, <span class="keyword">new</span> RunnableWithExceptionProtection.CallbackWhenException() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                    logger.error(<span class="string">"unexpected exception."</span>, t);</div><div class="line">                &#125;</div><div class="line">            &#125;), <span class="number">0</span>, Config.Collector.APP_AND_SERVICE_REGISTER_CHECK_INTERVAL, TimeUnit.SECONDS);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        applicationRegisterFuture.cancel(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        logger.debug(<span class="string">"AppAndServiceRegisterClient running, status:&#123;&#125;."</span>, status);</div><div class="line">        <span class="keyword">boolean</span> shouldTry = <span class="keyword">true</span>;</div><div class="line">        <span class="comment">// 在上面 statusChanged 方法改变状态为已连接后执行</span></div><div class="line">        <span class="keyword">while</span> (GRPCChannelStatus.CONNECTED.equals(status) &amp;&amp; shouldTry) &#123;</div><div class="line">            shouldTry = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 服务注册</span></div><div class="line">                <span class="comment">// APPLICATION_ID 默认值就是 DictionaryUtil.nullValue()</span></div><div class="line">                <span class="keyword">if</span> (RemoteDownstreamConfig.Agent.APPLICATION_ID == DictionaryUtil.nullValue()) &#123;</div><div class="line">                    <span class="comment">// 正常来说，states 为 CONNECTED 的话，applicationRegisterServiceBlockingStub 不会为 null</span></div><div class="line">                    <span class="keyword">if</span> (applicationRegisterServiceBlockingStub != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// APPLICATION_CODE 在 skywalking-agent 的 agent.conf 文件中配置</span></div><div class="line">                        Application request = Application.newBuilder().setApplicationCode(Config.Agent.APPLICATION_CODE).build();</div><div class="line">                        logger.debug(<span class="string">"AppAndServiceRegisterClient request:&#123;&#125;."</span>, request);</div><div class="line">                        ApplicationMapping applicationMapping = applicationRegisterServiceBlockingStub.applicationCodeRegister(</div><div class="line">                            Application.newBuilder().setApplicationCode(Config.Agent.APPLICATION_CODE).build());</div><div class="line">                        <span class="comment">// 从 response 中获取 APPLICATION_ID 设置到 RemoteDownstreamConfig.Agent</span></div><div class="line">                        <span class="keyword">if</span> (applicationMapping != <span class="keyword">null</span>) &#123;</div><div class="line">                            RemoteDownstreamConfig.Agent.APPLICATION_ID = applicationMapping.getApplication().getValue();</div><div class="line">                            shouldTry = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// 服务实例注册</span></div><div class="line">                    <span class="keyword">if</span> (instanceDiscoveryServiceBlockingStub != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (RemoteDownstreamConfig.Agent.APPLICATION_INSTANCE_ID == DictionaryUtil.nullValue()) &#123;</div><div class="line"></div><div class="line">                            ApplicationInstanceMapping instanceMapping = instanceDiscoveryServiceBlockingStub.registerInstance(ApplicationInstance.newBuilder()</div><div class="line">                                .setApplicationId(RemoteDownstreamConfig.Agent.APPLICATION_ID)</div><div class="line">                                .setAgentUUID(PROCESS_UUID)</div><div class="line">                                .setRegisterTime(System.currentTimeMillis())</div><div class="line">                                .setOsinfo(OSUtil.buildOSInfo())</div><div class="line">                                .build());</div><div class="line">                            <span class="keyword">if</span> (instanceMapping.getApplicationInstanceId() != DictionaryUtil.nullValue()) &#123;</div><div class="line">                                RemoteDownstreamConfig.Agent.APPLICATION_INSTANCE_ID</div><div class="line">                                    = instanceMapping.getApplicationInstanceId();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// 服务实例心跳检测</span></div><div class="line">                        <span class="keyword">else</span> &#123;</div><div class="line">                            instanceDiscoveryServiceBlockingStub.heartbeat(ApplicationInstanceHeartbeat.newBuilder()</div><div class="line">                                .setApplicationInstanceId(RemoteDownstreamConfig.Agent.APPLICATION_INSTANCE_ID)</div><div class="line">                                .setHeartbeatTime(System.currentTimeMillis())</div><div class="line">                                .build());</div><div class="line"></div><div class="line">                            NetworkAddressDictionary.INSTANCE.syncRemoteDictionary(networkAddressRegisterServiceBlockingStub);</div><div class="line">                            OperationNameDictionary.INSTANCE.syncRemoteDictionary(serviceNameDiscoveryServiceBlockingStub);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                logger.error(t, <span class="string">"AppAndServiceRegisterClient execute fail."</span>);</div><div class="line">                ServiceManager.INSTANCE.findService(GRPCChannelManager.class).reportError(t);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ContextManagerExtendService"><a href="#ContextManagerExtendService" class="headerlink" title="ContextManagerExtendService"></a>ContextManagerExtendService</h2><p>ContextManagerExtendService 作为 ContextManager 的扩展帮助类，代码比较简单，主要有两个功能:</p>
<ol>
<li>将 ContextManager 添加到 TracingContext、IgnoredTracerContext 的监听器集合中，等待 context 完成时通知。</li>
<li>帮助 ContextManager 创建 AbstractTracerContext。</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>SkyWalking Agent 具有丰富的插件支持，支持列表可见 github 官方项目</li>
<li>SkyWalking Agent 通过 ServiceManager 管理多个 BootService</li>
<li>TraceSegmentServiceClient 负责发送 TraceSegment 到 Collector</li>
<li>ContextManager 负责管理 TraceSegment 的上下文</li>
<li>SamplingService 负责管理如何进行 TraceSegment 的采样</li>
<li>GRPCChannelManager 负责管理 GRPCChannel 的创建及将状态发送至各个监听器</li>
<li>JVMService 负责将 JVM 以及 GC 信息发送到 Collector</li>
<li>AppAndServiceRegisterClient 作为一个客户端，负责进行服务注册、服务实例注册、心跳检测等调用</li>
<li>ContextManagerExtendService 作为 ContextManager 的扩展帮助类</li>
</ul>
<p>参考博文：<a href="http://www.iocoder.cn/categories/SkyWalking/" target="_blank" rel="external">芋道源码</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/11/26/SkyWalking-Agent源码浅析/">SkyWalking Agent源码浅析</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Lollipop</a></p>
        <p><span>发布时间:</span>2018-11-26, 21:24:06</p>
        <p><span>最后更新:</span>2018-11-27, 16:36:35</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/11/26/SkyWalking-Agent源码浅析/" title="SkyWalking Agent源码浅析">http://yoursite.com/2018/11/26/SkyWalking-Agent源码浅析/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2018/11/26/SkyWalking-Agent源码浅析/　　作者: Lollipop" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2018/11/27/SkyWalking-Collector源码浅析/">
                    SkyWalking Collector源码浅析
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2018/11/21/SkyWalking使用指南/">
                    Apache SkyWalking 使用指南
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SkyWalking-Agent-入口"><span class="toc-number">1.</span> <span class="toc-text">SkyWalking Agent 入口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化配置"><span class="toc-number">1.1.</span> <span class="toc-text">初始化配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化插件"><span class="toc-number">1.2.</span> <span class="toc-text">初始化插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PluginBootstrap"><span class="toc-number">1.2.1.</span> <span class="toc-text">PluginBootstrap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PluginFinder"><span class="toc-number">1.2.2.</span> <span class="toc-text">PluginFinder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化服务管理"><span class="toc-number">1.3.</span> <span class="toc-text">初始化服务管理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ServiceManager"><span class="toc-number">2.</span> <span class="toc-text">ServiceManager</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BootService"><span class="toc-number">3.</span> <span class="toc-text">BootService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TraceSegmentServiceClient"><span class="toc-number">3.1.</span> <span class="toc-text">TraceSegmentServiceClient</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DataCarrier"><span class="toc-number">3.1.1.</span> <span class="toc-text">DataCarrier</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Channels"><span class="toc-number">3.1.2.</span> <span class="toc-text">Channels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffer"><span class="toc-number">3.1.3.</span> <span class="toc-text">Buffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumerPool"><span class="toc-number">3.1.4.</span> <span class="toc-text">ConsumerPool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumerThread"><span class="toc-number">3.1.5.</span> <span class="toc-text">ConsumerThread</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ContextManager"><span class="toc-number">3.2.</span> <span class="toc-text">ContextManager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SamplingService"><span class="toc-number">3.3.</span> <span class="toc-text">SamplingService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GRPCChannelManager"><span class="toc-number">3.4.</span> <span class="toc-text">GRPCChannelManager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JVMService"><span class="toc-number">3.5.</span> <span class="toc-text">JVMService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AppAndServiceRegisterClient"><span class="toc-number">3.6.</span> <span class="toc-text">AppAndServiceRegisterClient</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ContextManagerExtendService"><span class="toc-number">3.7.</span> <span class="toc-text">ContextManagerExtendService</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"SkyWalking Agent源码浅析　| 小白爬坑之旅　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?'];
        </script>
    

    
</div>







    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function(){
            this.page.url = 'http://yoursite.com/2018/11/26/SkyWalking-Agent源码浅析/';
            this.page.identifier = '2018/11/26/SkyWalking-Agent源码浅析/';
        };
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = '//jimmy2angel.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <aside class="comment-bar">
        <a href="javascript:void(0);">
            <i class="fa fa-commenting-o animated infinite pulse"></i>
            <i class="fa fa-spinner fa-pulse"></i>
            <span class="count-comment"></span>
        </a>
    </aside>
    <script>
        var $commentBar = $("#comments aside.comment-bar");
        var load$hide = function(){
            $commentBar.find("a > i").toggle();
            loadComment();
            $commentBar.fadeOut(800);
        }
        $commentBar.click(function(){
            load$hide();
        })
        $commentBar.children("a").hover(function(){
            load$hide();
        })
        if (window.location.hash === "#comments") {
            load$hide();
        }
    </script>

</section>


    <script id="dsq-count-scr" src="//jimmy2angel.disqus.com/count.js" async></script>
    <span class="disqus-comment-count" data-disqus-identifier="2018/11/26/SkyWalking-Agent源码浅析/"></span>
    <span class="disqus-comment-count" data-disqus-url="http://yoursite.com/2018/11/26/SkyWalking-Agent源码浅析/"></span>
    <script>
        $(".disqus-comment-count").hide();
        var $disqusCount = $(".disqus-comment-count");
        $disqusCount.bind("DOMNodeInserted", function(e) {
            $(".count-comment").text(
                $(this).text().replace(/[^0-9]/ig,"")
            )
            DISQUSWIDGETS.getCount({reset: true});
        })
    </script>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/11/27/SkyWalking-Collector源码浅析/" title="上一篇: SkyWalking Collector源码浅析">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2018/11/21/SkyWalking使用指南/" title="下一篇: Apache SkyWalking 使用指南">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/27/SkyWalking-Collector源码浅析/">SkyWalking Collector源码浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/26/SkyWalking-Agent源码浅析/">SkyWalking Agent源码浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/21/SkyWalking使用指南/">Apache SkyWalking 使用指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/27/SpringBoot源码解析二/">SpringBoot源码解析二</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/26/ConstantPool/">常量池及字符串对象的创建</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/09/SpringBoot源码解析一/">SpringBoot源码解析一</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/27/ThreadPoolExecutor/">ThreadPoolExecutor</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/BlockingQueue/">BlockingQueue</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/09/ExecutionEngine-md/">《深入理解Java虚拟机》之 字节码执行引擎</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/ClassLoading/">《深入理解Java虚拟机》之 类加载机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/05/MemoryAllocationAndGC/">《深入理解Java虚拟机》之GC</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/02/JVM-MemoryArea/">《深入理解Java虚拟机》之Java内存区域</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/31/HashSet和TreeSet/">HashSet 和 TreeSet</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/HashMap/">JAVA8的HashMap</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/10/SpringMVC-container/">SpringMVC容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/SpringIOC/">Spring容器那点事</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/linux-deploy/">虚拟机设置固定IP及部署java项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/25/DecorateAndProxy/">装饰模式 和 代理模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/22/mybatis-mapper/">源码解析mapper接口代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/18/Design-Patterns-Proxy/">代理模式及动态代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/18/hexo+github pages/">Hexo+Github Pages写博客</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2017-2018 Lollipop
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(*´∇｀*)出错啦！点我看看" + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "" + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>